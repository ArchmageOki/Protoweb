<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/src/style.css" />
    <title>Ajustes – Clientes</title>
  </head>
  <body class="bg-gray-50 text-slate-800">
    <div id="app" class="min-h-screen flex">
      <div class="flex-1 main-wrapper lg:ml-64">
        <header class="sticky top-0 z-30 bg-white border-b border-slate-200">
          <div class="flex items-center gap-2 p-4">
            <button id="sidebarOpen" class="lg:hidden p-2 rounded hover:bg-slate-100" aria-label="Abrir menú">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="size-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
            </button>
            <h1 class="text-lg font-semibold">Ajustes / Clientes</h1>
          </div>
        </header>
        <main class="p-6 space-y-6">
          <section class="rounded-lg border border-slate-200 bg-white p-5" id="cliente-column-selector-root">
            <header class="mb-4">
              <h2 class="text-sm font-semibold tracking-wide text-slate-700 uppercase">Visibilidad de columnas</h2>
              <p class="mt-1 text-xs text-slate-500 max-w-prose">Configura qué columnas aparecen en la tabla de clientes. Nombre y Móvil siempre visibles.</p>
            </header>
            <fieldset class="space-y-4" aria-describedby="cliente-column-selector-help">
              <legend class="sr-only">Columnas visibles</legend>
              <div id="cliente-column-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm"></div>
              <div class="flex flex-wrap gap-2">
                <button type="button" id="cliente-cols-guardar" class="inline-flex items-center gap-2 rounded-md bg-slate-900 text-white px-3 py-2 text-xs hover:bg-slate-800">Guardar selección</button>
                <button type="button" id="cliente-cols-restablecer" class="inline-flex items-center gap-2 rounded-md border border-slate-300 px-3 py-2 text-xs hover:bg-slate-100">Restablecer todo</button>
              </div>
              <p id="cliente-column-selector-help" class="text-[11px] leading-snug text-slate-500">Se guarda localmente y se aplica en /clientes.</p>
            </fieldset>
          </section>
        </main>
      </div>
    </div>
    <script type="module" src="/src/layout/inject-sidebar.js"></script>
    <script type="module" src="/src/main.js"></script>
    <script type="module" src="/src/user-menu.js"></script>
    <script>
    (function(){
      const KEY = 'app.settings'
      const root = document.getElementById('cliente-column-selector')
      if(!root) return
      const AVAILABLE = [
        { key:'nombre', label:'Nombre', locked:true },
        { key:'apellidos', label:'Apellidos' },
        { key:'movil', label:'Móvil', locked:true },
        { key:'instagram', label:'Instagram' },
        { key:'dni', label:'DNI' },
        { key:'direccion', label:'Dirección' },
        { key:'codigoPostal', label:'Código postal' },
        { key:'nacimiento', label:'Nacimiento' },
        { key:'visitas', label:'Citas totales' },
        { key:'dineroTotal', label:'Dinero total' },
        { key:'ultimaCita', label:'Última cita' },
        { key:'notas', label:'Notas' }
      ]
      const LOCKED = AVAILABLE.filter(c=>c.locked).map(c=>c.key)
      let current = AVAILABLE.map(c=>c.key)
      function persistLocal(cols){
        try { const prev = JSON.parse(localStorage.getItem(KEY)||'{}'); const next = { ...prev, clientes:{ ...(prev.clientes||{}), visibleColumns: cols } }; localStorage.setItem(KEY, JSON.stringify(next)) } catch {}
      }
      async function loadRemote(){
        try {
          const r = await fetch('/api/data/settings', { credentials:'include' })
          if(!r.ok) throw new Error('settings_fetch_failed')
          const j = await r.json()
          const remoteCols = j?.settings?.clientes?.visibleColumns
          if(Array.isArray(remoteCols) && remoteCols.length){ current = remoteCols }
        } catch(e){
          try { const saved = JSON.parse(localStorage.getItem(KEY)||'{}'); const cols = saved.clientes?.visibleColumns; if(Array.isArray(cols)&&cols.length) current=cols } catch{}
        }
        // Asegurar locked siempre
        const set = new Set(current); let changed=false
        LOCKED.forEach(k=>{ if(!set.has(k)){ set.add(k); changed=true } })
        if(changed){ current = Array.from(set) }
        render()
      }
      function render(){
        root.innerHTML=''
        AVAILABLE.forEach(col=>{
          const id='col-vis-'+col.key
          const div=document.createElement('label')
          const isChecked=current.includes(col.key)
          const locked=!!col.locked
          div.className='flex items-center gap-2 rounded border border-slate-300 px-2 py-1 text-xs cursor-pointer hover:bg-slate-50'+(locked?' opacity-80':'')
          div.innerHTML=`<input type="checkbox" id="${id}" data-col-key="${col.key}" class="rounded border-slate-300" ${isChecked?'checked':''} ${locked?'disabled':''}/> <span>${col.label}${locked?' *':''}</span>`
          root.appendChild(div)
        })
      }
      async function saveRemote(cols){
        // Persistir backend + local
        persistLocal(cols)
        try {
          await fetch('/api/data/settings', {
            method:'PUT', headers:{ 'Content-Type':'application/json' }, credentials:'include',
            body: JSON.stringify({ clientes:{ visibleColumns: cols } })
          })
        } catch{}
      }
      const saveBtn=document.getElementById('cliente-cols-guardar')
      const resetBtn=document.getElementById('cliente-cols-restablecer')
      saveBtn?.addEventListener('click', ()=>{
        let cols=Array.from(root.querySelectorAll('input[data-col-key]:checked')).map(i=>i.getAttribute('data-col-key'))
        LOCKED.forEach(k=>{ if(!cols.includes(k)) cols.push(k) })
        current=cols
        saveBtn.disabled=true; const orig=saveBtn.textContent; saveBtn.textContent='Guardando…'
        saveRemote(cols).finally(()=>{ saveBtn.textContent='Guardado'; setTimeout(()=>{ saveBtn.textContent=orig; saveBtn.disabled=false }, 1200) })
      })
      resetBtn?.addEventListener('click', ()=>{
        current = AVAILABLE.map(c=>c.key)
        render()
        saveRemote(current)
      })
      loadRemote()
    })()
    </script>
  </body>
</html>
