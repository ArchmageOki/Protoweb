<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conectar WhatsApp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Cargar estilos (Tailwind + custom) -->
  <link rel="stylesheet" href="/src/style.css">
</head>
<body class="bg-gray-50 text-slate-800">
  <div id="app" class="min-h-screen flex">
    <div class="flex-1 main-wrapper lg:ml-64 flex flex-col">
      <header class="sticky top-0 z-30 bg-white border-b border-slate-200">
        <div class="flex items-center gap-2 p-4">
          <button id="sidebarOpen" class="lg:hidden p-2 rounded hover:bg-slate-100" aria-label="Abrir menú">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="size-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
          </button>
          <h1 class="text-lg font-semibold">Conectar WhatsApp</h1>
          <div id="wa-status-bar" class="ml-auto text-xs text-slate-500"></div>
        </div>
      </header>
      <main class="flex-1 p-6 flex justify-center items-start">
        <form id="wa-login-form" class="w-full max-w-md bg-white border border-slate-200 rounded-lg p-6 shadow-sm">
          <div class="space-y-1">
            <label for="wa-phone" class="text-sm font-medium text-slate-700">Número de teléfono</label>
            <input id="wa-phone" name="phone" type="text" autocomplete="off" placeholder="34600111222" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400" required />
          </div>
          <div id="wa-feedback" class="text-xs text-slate-500 mt-2"></div>
          <div class="flex gap-2 mt-4">
            <button type="submit" class="flex-1 inline-flex items-center justify-center gap-2 rounded-md bg-slate-900 text-white px-4 py-2 text-sm font-medium hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed">Vincular</button>
            <button type="button" id="wa-reset" class="inline-flex items-center justify-center rounded-md bg-orange-500 text-white px-4 py-2 text-sm font-medium hover:bg-orange-600 disabled:opacity-50">Reiniciar</button>
          </div>
          <!-- Bloque QR expandible -->
          <div id="wa-next" class="hidden mt-6 border-t border-slate-200 pt-6 text-sm">
            <p class="mb-2 font-medium text-slate-700">Escanea este QR</p>
            <p class="text-xs text-slate-600 mb-3">En WhatsApp: Dispositivos vinculados &gt; Vincular dispositivo y escanea el código.</p>
            <div class="flex justify-center"><canvas id="wa-qr" class="border border-slate-200 rounded"></canvas></div>
            <p id="wa-status" class="mt-3 text-xs text-slate-500">Generando QR...</p>
            <!-- Botones secundarios eliminados -->
          </div>
        </form>
      </main>
    </div>
  </div>
  <script type="module">
    const KEY = 'whatsapp.sessionPhone'
    const API = (p)=>`http://localhost:4001${p}`
    const form = document.getElementById('wa-login-form')
    const phoneInput = document.getElementById('wa-phone')
    const feedback = document.getElementById('wa-feedback')
    const nextBox = document.getElementById('wa-next')
  const qrCanvas = document.getElementById('wa-qr')
    const statusEl = document.getElementById('wa-status')
  // Botones secundarios eliminados
  const resetBtn = document.getElementById('wa-reset')
  const statusBar = document.getElementById('wa-status-bar')

    let QRLibPromise = null
    async function ensureQR(){
      if(!QRLibPromise){
        QRLibPromise = import('qrcode')
      }
      return QRLibPromise
    }

    async function renderQR(data){
      if(!data) return
      const { default: QRCode } = await ensureQR()
      const size = 260
      // Limpiar canvas
      const ctx = qrCanvas.getContext('2d')
      ctx.clearRect(0,0,qrCanvas.width, qrCanvas.height)
      // Generar un dataURL y dibujarlo en canvas para simplicidad
      try {
        const url = await QRCode.toDataURL(data, { width: size, margin: 2 })
        const img = new Image()
        img.onload = ()=>{ qrCanvas.width = size; qrCanvas.height = size; ctx.drawImage(img,0,0,size,size) }
        img.src = url
      } catch(e){
        statusEl.textContent = 'Error generando QR';
      }
    }

    async function fetchJSON(url, opts){
      const res = await fetch(url, { headers:{'Content-Type':'application/json'}, ...opts })
      if(!res.ok) throw new Error('HTTP '+res.status)
      return res.json()
    }

    async function poll(phone){
      try {
        const st = await fetchJSON(API(`/whatsapp/status?phone=${phone}`))
  statusBar.textContent = st.state
  if(st.qr && st.state === 'qr'){
          nextBox.classList.remove('hidden')
          renderQR(st.qr)
          statusEl.textContent = 'Escanea el QR con tu móvil.'
        }
        if(st.state === 'ready'){
          statusEl.textContent = 'Conectado. Redirigiendo...'
            setTimeout(()=>{ window.location.href = '/mensajes.html' }, 800)
          return
        }
      } catch(e){ /* silent */ }
      setTimeout(()=>poll(phone), 4000)
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault()
      let phone = phoneInput.value.trim().replace(/[^0-9]/g,'')
      if(phone.length < 8){ feedback.textContent = 'Número inválido'; return }
      feedback.textContent = 'Creando sesión...' ;
      try {
        const resp = await fetchJSON(API('/whatsapp/start'), { method:'POST', body: JSON.stringify({ phone })})
        localStorage.setItem(KEY, phone)
        feedback.textContent = ''
        nextBox.classList.remove('hidden')
        if(resp.qr){ renderQR(resp.qr); statusEl.textContent='Escanea el QR con tu móvil.' }
        poll(phone)
      } catch(e){ feedback.textContent = 'Error: '+e.message }
    })

  resetBtn?.addEventListener('click', async ()=>{
      const phone = phoneInput.value.trim().replace(/[^0-9]/g,'')
      if(!phone){ feedback.textContent='Introduce número'; return }
      feedback.textContent='Reseteando...';
      try {
        await fetchJSON(API('/whatsapp/reset'), { method:'POST', body: JSON.stringify({ phone })})
        await fetchJSON(API('/whatsapp/start'), { method:'POST', body: JSON.stringify({ phone, reset:true })})
        feedback.textContent='Sesión reiniciada';
        localStorage.setItem(KEY, phone)
        setTimeout(()=>poll(phone), 500)
      } catch(e){ feedback.textContent='Error reset: '+e.message }
    })
  // Inyectar sidebar dinámicamente
  import('/src/layout/inject-sidebar.js') // mantiene ruta absoluta para Vite

  // Eliminado goBtn obsoleto
  </script>
</body>
</html>
